stages:
  - build
  - test
  - docker
  - gitops

variables:
  HARBOR_REGISTRY: registry.nuha.care
  IMAGE_NAME: endryco/kirito
  DOCKER_IMAGE: $HARBOR_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA
  APP_NAME: kirito
  CGO_ENABLED: "0"
  GOOS: "linux"
  GOARCH: "amd64"

# ---------------- BUILD ----------------
build:
  stage: build
  image: golang:1.23-alpine
  cache:
    paths:
      - /go/pkg/mod
  script:
    - apk add --no-cache git ca-certificates
    - go mod download
    - go test ./... -v
    - go build -o $APP_NAME main.go
  artifacts:
    paths:
      - $APP_NAME
  tags:
    - golang
  rules:
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"


# ---------------- TEST ----------------
test:
  stage: test
  image: golang:1.23-alpine
  script:
    - apk add --no-cache git
    - go test ./... -v
  tags:
    - golang
  rules:
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"


# ---------------- DOCKER BUILD ----------------
docker:
  stage: docker
  image: docker:24.0.2
  before_script:
    - docker info
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_REGISTRY -u "$HARBOR_USERNAME" --password-stdin
  script:
    - docker pull $DOCKER_IMAGE || true
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE
  needs:
    - build
  tags:
    - docker
  rules:
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"

update_manifest:
  stage: gitops
  image:
    name: alpine:latest
    entrypoint: ["/bin/sh", "-c"]
  
  before_script:
    - apk add --no-cache git curl yq
    
    # Set Git config global untuk credentials
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  
  script:
    - set -e

    # ---- STEP 1: Prepare manifest directory ----
    - echo "=== Prepare manifest directory ==="
    - rm -rf manifest-argocd
    
    # ---- STEP 2: Clone manifest repo ----
    - echo "=== Clone manifest repo ==="
    - |
      git clone -b "$GITOPS_BRANCH" \
        "http://oauth2:${GITOPS_TOKEN}@${GITOPS_REPO}" \
        manifest-argocd
    
    # ---- STEP 3: Update image tag ----
    - echo "=== Update image tag in /k3s/values.yaml ==="
    - yq e ".image.tag = \"${CI_COMMIT_SHA}\"" -i manifest-argocd/k3s/values.yaml
    - echo "Updated /k3s/values.yaml with tag:${CI_COMMIT_SHA}"
    - echo "Content after update:"
    - yq e '.image' manifest-argocd/k3s/values.yaml

    # ---- STEP 4: Commit & Push ----
    - echo "=== Commit & push manifest update ==="
    - cd manifest-argocd
    
    # Reconfigure git remote dengan credentials untuk push
    - git remote set-url origin "http://oauth2:${GITOPS_TOKEN}@${GITOPS_REPO}"
    
    # Add, commit, push
    - git add k3s/values.yaml
    - git diff --cached
    - git commit -m "ci update image tag ${CI_COMMIT_SHA}" || echo "⚠️  No changes to commit"
    - git push origin "${CI_COMMIT_BRANCH}"
    
    - echo "✅ Manifest updated successfully!"
  
  tags:
    - golang
  
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: always